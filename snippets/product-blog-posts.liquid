{% comment %}
  Custom block for product template that displays blog posts with a matching tag.
{% endcomment %}

{% style %}
{% endstyle %}

{% liquid
  assign articles_all = blogs.stories.articles
  assign articles_related_handles = ''
  assign product_tag = product.metafields.blog.tags

  for article in articles_all
    if article.tags contains product_tag
      assign articles_related_handles = articles_related_handles | append: article.handle
      assign articles_related_handles = articles_related_handles | append: ','
    endif
  endfor

  if articles_related_handles != empty
    assign articles_related_handles = articles_related_handles | split: ','
  else
    assign articles_related_handles = ''
  endif
%}

<div class="related-blog-posts isolate">
  <div class="rich-text content-container color-background-1 gradient rich-text--full-width content-container--full-width">
    <div class="rich-text__wrapper rich-text__wrapper--left page-width">
      <div class="rich-text__blocks">
        <h2
          class="rich-text__heading rte inline-richtext h1 scroll-trigger animate--slide-in"
          data-cascade
          style="--animation-order: 3;"
        >
          Related Blog Posts
        </h2>
        <div
          class="block-sizing rich-text__text rte scroll-trigger animate--slide-in"
          data-cascade
          style="--animation-order: 4;"
        >
          {% if product_tag != empty %}
            {% for handle in articles_related_handles %}
              {% assign article = articles[handle] %}
              {% assign content = article.content | strip_html %}
              <div class="article">
                <small>{{ article.created_at | date: '%b %d, %y' }}</small>
                <h4>{{ article.title }}</h4>
                <p>{{ content | truncate: 100 }}</p>

                <img
                  src="{{ article.image.src |image_url: width: 200, height: 200 }}"
                  alt="{{ article.image.alt | escape }}"
                  width="200"
                >
              </div>
            {% endfor %}
          {% else %}
            blog.tags is empty.
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
